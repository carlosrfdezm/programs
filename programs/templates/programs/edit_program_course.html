{% extends 'programs/base.html' %}
{% load static %}
{% load extra_tags %}

{% block content %}
    {% if program.type == 'phd' %}
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-9">
                        <h1> Editar componente de {{ program }} </h1>
                    </div>
                    <div class="col-sm-3">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="{% url 'programs:home' program.slug %}">Dashboard</a></li>
                            <li class="breadcrumb-item active">Editar componente</li>
                        </ol>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <!-- left column -->
                    <div class="col-md-12">
                        <!-- general form elements -->
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title">Componente</h3>
                            </div>
                            <!-- /.card-header -->
                            <!-- form start -->
                            {% if component %}
                                <form role="form" method="post" enctype="multipart/form-data" action="{% url 'programs:edit_program_course' program.slug component.id %}">
                                    {% csrf_token %}
                                    <div class="card-body">
                                        <div class="form-row">
                                            <div class="form-group col-md-12">
                                                <label for="inp_name">Nombre del componente:</label>
                                                <input class="form-control" id="inp_name" name="course_name" value="{{ component.name }}" placeholder="Nombre del componente." maxlength="250" required>
                                            </div>

                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-12">
                                                <label for="txt_description">Descripción:</label>
                                                <textarea class="form-control" id="txt_description" name="course_description"  placeholder="Descripción del componente" maxlength="500" rows="5" required >{{ component.description }}</textarea>
                                            </div>

                                        </div>


                                    </div>
                                    <!-- /.card-body -->

                                    <div class="card-footer">
                                        <button type="submit" class="btn btn-primary">Guardar</button>
                                    </div>
                                </form>
                            {% else %}
                                <div class="alert alert-warning">
                                    <h3>No se ha elegido ningún curso.</h3>
                                </div>>
                            {% endif %}
                        </div>
                        <!-- /.card -->



                        <!-- /.card -->

                        <!-- Input addon -->
                        <!-- /.card -->
                        <!-- Horizontal Form -->
                        <!-- /.card -->

                    </div>
                    <!--/.col (left) -->
                    <!-- right column -->
                    <!--/.col (right) -->
                </div>
                <!-- /.row -->
            </div><!-- /.container-fluid -->
        </section>
        <!-- /.content -->
    {% else %}
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-9">
                        <h1> Editar curso de la {{ edition }}a edición. </h1>
                    </div>
                    <div class="col-sm-3">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="{% url 'programs:home' program.slug %}">Dashboard</a></li>
                            <li class="breadcrumb-item active">Editar curso</li>
                        </ol>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <!-- left column -->
                    <div class="col-md-12">
                        <!-- general form elements -->
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title">Curso</h3>
                            </div>
                            <!-- /.card-header -->
                            <!-- form start -->
                            {% if component %}
                                <form role="form" method="post" enctype="multipart/form-data" action="{% url 'programs:edit_program_course' program.slug component.id %}">
                                    {% csrf_token %}
                                    <div class="card-body">
                                        <div class="form-row">
                                            <div class="form-group col-md-12">
                                                <label for="inp_name">Nombre del curso:</label>
                                                <input class="form-control" id="inp_name" name="course_name" value="{{ component.name }}" placeholder="Nombre del componente." maxlength="250" required>
                                            </div>

                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-12">
                                                <label for="txt_description">Descripción:</label>
                                                <textarea class="form-control" id="txt_description" name="course_description"  placeholder="Descripción del curso" maxlength="500" rows="5" required >{{ component.description }}</textarea>
                                            </div>

                                        </div>
                                        <div class="form-row">

                                            <div class="form-group col-md-6">
                                                <label for="inp_init_date">Fecha de inicio:</label>
                                                <input type="date" class="form-control" id="inp_init_date" name="init_date" value="{{ component.init_date|date:'Y-m-d' }}" required>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label for="inp_end_date">Fecha de fin:</label>
                                                <input type="date" class="form-control" id="inp_end_date" name="end_date" value="{{ component.end_date|date:'Y-m-d' }}" required >
                                            </div>

                                        </div>
                                        <hr>
                                        <div class="form-row">
                                            <div class="col-md-11">
                                                <h5><strong>Profesores:</strong></h5>
                                            </div>
                                            <div class="col-md-1 pl-4">

                                                <button type="button" class="text-white btn btn-sm btn-warning" id="btn_add_prof" title="Agregar profesor"><i class="fa fa-plus"></i></button>
                                            </div>
                                        </div>
                                        <section id="old_professors">
                                            {% for professor in component.courseprofessor_set.all %}

                                                <div class="form-row align-items-center pb-2" id="div_prof_{{ professor.id }}">
                                                    <div class="col-md-3">
                                                        <input type="email" class="form-control" readonly id="inp_prof_email_{{ professor.id }}" name="prof_email_{{ professor.id }}" value="{{ professor.professor.user.email }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input type="text" class="form-control" readonly id="inp_prof_name_{{ professor.id }}" name="prof_name_{{ professor.id }}" value="{{ professor.professor.user.first_name }}" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <input type="text" class="form-control" readonly id="inp_prof_lastname_{{ professor.id }}" name="prof_lastname_{{ professor.id }}" value="{{ professor.professor.user.last_name }}" required></input>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <input type="text" class="form-control" readonly id="inp_prof_institution_{{ professor.id }}" name="prof_institution_{{ professor.id }}" value="{{ professor.professor.institution }}" required></input>
                                                    </div>
                                                    <div class="col-md-1 pl-4 ">

                                                        <button type="button" class="text-white btn btn-sm btn-danger" id="btn_rm_{{ professor.id }}" title="Eliminar profesor" data-toggle="modal" data-target="#modal_rm_prof_{{ professor.id }}"><i class="fa fa-minus"></i> </button>
                                                    </div>
                                                </div>
                                                <div class="modal fade" id="modal_rm_prof_{{ professor.id }}">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h4 class="modal-title">Eliminar profesor</h4>
                                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                    <span aria-hidden="true">&times;</span>
                                                                </button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="row">
                                                                    <div class="col-md-2">
                                                                        <span class="text-danger"><i class="fa fa-exclamation-triangle fa-4x"></i></span>

                                                                    </div>
                                                                    <div class="col-md-10">
                                                                        <p class="text-center">¿Seguro que desea eliminar a:<br><strong>{{ professor }}</strong>
                                                                            <br> de la lista de profesores de este curso?</p>
                                                                    </div>
                                                                </div>

                                                            </div>
                                                            <div class="modal-footer justify-content-between">
                                                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                                                                <button type="button" class="btn btn-danger" data-dismiss="modal" data="{{ professor.id }}" id="btn_rm_prof_{{ professor.id }}">Eliminar</button>
                                                            </div>
                                                        </div>
                                                        <!-- /.modal-content -->
                                                    </div>
                                                    <!-- /.modal-dialog -->
                                                </div>
                                            {% endfor %}
                                            {% if not component.courseprofessor_set.all %}
                                                <div class="alert alert-info col-md-10 offset-1" id="div_not_prof">
                                                    <h5 class="text-center"> Este curso no tiene profesores, por favor agregue al menos uno</h5>
                                                </div>
                                            {% endif %}
                                        </section>
                                        <section id="new_professors">

                                        </section>




                                    </div>
                                    <!-- /.card-body -->

                                    <div class="card-footer">
                                        <input type="hidden" id="inp_new_prof" name="total_new_prof" value="0">
                                        <button type="submit" class="btn btn-primary">Guardar</button>
                                    </div>
                                </form>
                            {% else %}
                                <div class="alert alert-warning">
                                    <h3>No se ha elegido ningún curso.</h3>
                                </div>>
                            {% endif %}
                        </div>
                        <!-- /.card -->



                        <!-- /.card -->

                        <!-- Input addon -->
                        <!-- /.card -->
                        <!-- Horizontal Form -->
                        <!-- /.card -->

                    </div>
                    <!--/.col (left) -->
                    <!-- right column -->
                    <!--/.col (right) -->
                </div>
                <!-- /.row -->
            </div><!-- /.container-fluid -->
        </section>

    {% endif %}
{% endblock %}
{% block extra_scripts %}
    <!-- jQuery -->
    <script src="../../plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- bs-custom-file-input -->
    <script src="../../plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>
    <!-- AdminLTE App -->
    <script src="../../dist/js/adminlte.min.js"></script>
    <!-- AdminLTE for demo purposes -->
    <script src="../../dist/js/demo.js"></script>

    <script>
        $(document).ready(function () {
            var old_professors = {{ component.courseprofessor_set.all.count }};
            var total_new_prof = 0;
            var today = new Date();

            var mm = today.getMonth(); //January is 0!
            var yyyy = today.getFullYear();
            var meses =[ "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre","Octubre", "Noviembre", "Diciembre" ];

            for(var i = 0; i<= mm;i++){
                if(i==mm){
                    var option = '<option value="'+meses[i]+'"selected >'+meses[i]+'</option>';
                }
                else{
                    var option = '<option value="'+meses[i]+'" >'+meses[i]+'</option>';

                }

                $('#slc_months').append(option);


            }
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 7000
            });



            $('#slc_years').change(function () {

                $('#slc_months option').remove();
                $('#slc_months').append('<option value="" selected>Seleccione una opción</option>');

                if($(this).val()== yyyy){
                    for(var i = 0; i<= mm;i++){
                        if(i==mm){
                            var option = '<option value="'+meses[i]+'"selected >'+meses[i]+'</option>';
                        }
                        else{
                            var option = '<option value="'+meses[i]+'" >'+meses[i]+'</option>';

                        }

                        $('#slc_months').append(option);


                    }

                }
                else {
                    for(var i = 0; i< meses.length; i++){

                        var option = '<option value="'+meses[i]+'">'+meses[i]+'</option>';
                        $('#slc_months').append(option);

                    }
                }

            });
            $(document).on('click','#btn_add_prof', function () {
                var old_new_prof = total_new_prof;
                total_new_prof = total_new_prof+ 1;
                $('#inp_prof_email_'+old_new_prof).attr('readonly', 'readonly');
                $('#div_not_prof').remove();


                $('#inp_new_prof').val(total_new_prof);
                var new_prof_div = '<div class="form-row align-items-center pb-2" id="div_new_prof_'+total_new_prof+'">\n' +
                    '                                    <div class="col-md-3">\n' +
                    '                                        <input type="email" class="form-control" id="inp_new_prof_email_'+total_new_prof+'" data="'+total_new_prof+'" name="new_prof_email_'+total_new_prof+'" placeholder="Email del profesor" required="">\n' +
                    '                                    </div>\n' +
                    '                                    <div class="col-md-2">\n' +
                    '                                        <input type="text" class="form-control" readonly="" id="inp_new_prof_name_'+total_new_prof+'" name="new_prof_name_'+total_new_prof+'" placeholder="Nombre(s) del profesor" required="">\n' +
                    '                                    </div>\n' +
                    '                                    <div class="col-md-3">\n' +
                    '                                        <input type="text" class="form-control" readonly="" id="inp_new_prof_lastname_'+total_new_prof+'" name="new_prof_lastname_'+total_new_prof+'" placeholder="Apellidos del profesor" required="">\n' +
                    '                                    </div>\n' +
                    '                                    <div class="col-md-3">\n' +
                    '                                        <input type="text" class="form-control" readonly="" id="inp_new_prof_institution_'+total_new_prof+'" name="new_prof_institution_'+total_new_prof+'" placeholder="Institución del profesor" required="">\n' +
                    '                                    </div>\n' +
                    '                                    <div class="col-md-1 pl-4 " id="div_rm_prof_'+total_new_prof+'">\n' +
                    '                                        <button type="button" class="text-white btn btn-sm btn-danger" id="btn_rm_new_prof_'+total_new_prof+'" data="'+total_new_prof+'" title="Eliminar profesor"><i class="fa fa-minus"></i> </button>' +
                    '                                    </div>\n' +
                    '\n' +
                    '\n' +
                    '                                </div>'

                $('#btn_rm_new_prof_'+old_new_prof).remove();
                $('#new_professors').append(new_prof_div);
                $(this).addClass('disabled')
            });
            $(document).on('keyup', "input[name*='prof_email']", function () {
                var index = $(this).attr('data');
                var email = $(this).val();
                var id = '#'+$(this).attr('id');
                var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
                if(emailReg.test( email ) && email != ''){
                    var url = "{% url 'programs:ajx_program_member_tuthor' program.slug %}"
                    $.ajax({
                        url : url,
                        type : "POST", // http method
                        data : {'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
                            'tuthor_email':email,
                        }, // data sent with the post request

                        // handle a successful response
                        success : function(json) {

                            if (json[0] == 1) {


                                $('#inp_new_prof_name_'+index).val(json[1][0]);
                                $('#inp_new_prof_lastname_'+index).val(json[1][1]);
                                $('#inp_new_prof_institution_'+index).val(json[1][2]);
                                $('#btn_add_prof').removeClass('disabled');
                                var email_is_on_input = false;
                                for(var i =1;i< index;i++){
                                    if($('#inp_new_prof_email_'+i).val() == email){
                                        email_is_on_input = true
                                    }
                                }
                                for(var i =1;i< old_professors+1;i++){
                                    if($('#inp_prof_email_'+i).val() == email){
                                        email_is_on_input = true
                                    }
                                }
                                if(email_is_on_input){
                                    Toast.fire({
                                        type: 'error',
                                        title: 'Al parecer está duplicando el profesor del curso, revise la entrada de correos de profesores.'
                                    });
                                    $(id).val('');
                                    $('#inp_new_prof_name_'+index).val('');
                                    $('#inp_new_prof_lastname_'+index).val('');
                                    $('#inp_new_prof_institution_'+index).val('');
                                    $('#btn_add_prof').addClass('disabled');
                                }

                            } else if(json[0] == 0){
                                Toast.fire({
                                    type: 'error',
                                    title: 'No existe miembro del claustro con ese email, debe agregarlo previamente.'
                                });
                                $(id).val('');
                                $('#inp_prof_name_'+index).val('');
                                $('#inp_prof_lastname_'+index).val('');
                                $('#inp_prof_institution_'+index).val('');




                            }
                            console.log(json); // log the returned json to the console
                            console.log("success"); // another sanity check




                            {#$('#div_by_workshop').removeClass('hidden')#}

                        },

                        // handle a non-successful response
                        error : function(xhr,errmsg,err) {
                            $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                                " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                        }
                    });
                }
                else{
                    $('#inp_tuthor_name_'+index).attr('readonly','readonly');
                    $('#inp_tuthor_lastname_'+index).attr('readonly','readonly');
                    $('#inp_tuthor_institution_'+index).attr('readonly','readonly');

                }
            });
            $(document).on('click',"button[id*='btn_rm_new_prof']",function () {
                var current_index = $(this).attr('data');

                var div_selector = '#div_new_prof_'+ current_index;
                $(div_selector).remove();

                total_new_prof = total_new_prof -1;

                $('#inp_total_new_prof').val(total_new_prof);
                if(old_professors+total_new_prof == 0){
                    $('#new_professors').append('<div class="alert alert-info col-md-10 offset-1" id="div_not_prof">\n' +
                        '                                                    <h5 class="text-center"> Este curso no tiene profesores, por favor agregue al menos uno</h5>\n' +
                        '                                                </div>')

                }
                $('#btn_add_prof').removeClass('disabled');


            });
            $(document).on('click',"button[id*='btn_rm_prof_']",function () {
                    var professor_id=$(this).attr('data');
                    var url = "{% url 'programs:ajx_delete_course_professor' program.slug %}";

                    {#$('#modal_rm_line_{{ line.id }}').modal('hide');#}

                    $.ajax({
                        url : url,
                        type : "POST", // http method
                        data : {'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
                            'professor_id':professor_id,
                        }, // data sent with the post request

                        // handle a successful response
                        success : function(json) {

                            if (json[0].deleted == 1) {

                                $('#div_prof_'+professor_id).remove();

                                Toast.fire({
                                    type: 'success',
                                    title: 'Profesor eliminado exitosamente'
                                });

                            } else if(json[0].deleted == 0){
                                Toast.fire({
                                    type: 'error',
                                    title: 'No se ha podido eliminar el profesor seleccionado.'
                                })

                            }
                            else if(json[0].deleted == 2){
                                Toast.fire({
                                    type: 'error',
                                    title: 'Usted no tiene privilegios para eliminar el profesor seleccionado.'
                                })

                            }
                            console.log(json); // log the returned json to the console
                            console.log("success"); // another sanity check




                            {#$('#div_by_workshop').removeClass('hidden')#}

                        },

                        // handle a non-successful response
                        error : function(xhr,errmsg,err) {
                            Toast.fire({
                                type: 'error',
                                title: 'Uff, ha ocurrido algo desconocido.'
                            })
                        }
                    });

                });
        });
    </script>
{% endblock %}
</body>
</html>
